<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monitor Dashboard | Emergency Assist+</title>
  <link rel="stylesheet" href="style.css">

  <!-- ===== FIREBASE ===== -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- ===== GOOGLE MAPS ===== -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyALmKTZrmeL3RC6M5DUEZVbYHTscMlk2Bo"></script>
</head>
<body>

<div class="dashboard">

  <div class="alert-header">
    ğŸš¨ EMERGENCY ALERT
    <p id="alertInfo">Waiting for emergency...</p>
  </div>
     <!-- MAP PREVIEW -->
  <div class="map-container">
    <iframe
      id="mapFrame"
      src="https://maps.google.com/maps?q=14.5995,120.9842&z=15&output=embed"
      width="100%"
      height="150"
      style="border:0;border-radius:12px;"
      loading="lazy">
    </iframe>
  </div>

  <!-- âœ… MAIN MONITOR MAP -->
  <div id="monitorMap" style="width:150%; height:180px; border-radius:12px;"></div>

     <!-- âœ… ACTION BUTTONS -->
 <div class="actions">
  <button class="green" onclick="callHospital()">ğŸ“ Call Nearest Hospital</button>
  <button class="blue" onclick="navigate()">ğŸ§­ Live Navigation</button>
  <button class="red" onclick="callEmergency()">ğŸš‘ Call Emergency</button>
  <button class="yellow" onclick="callPatient()">ğŸ“± Call Patient</button>
</div>

<p id="actionStatus" style="font-size:12px;color:#345;margin-top:6px;"></p>
    ğŸ”Œ Waiting for patient monitor...
  </p>

  <div class="disclaimer">
    âš ï¸ AI first aid advice is for general guidance only.<br>
    Always consult a medical professional.
  </div>

</div>


<!-- ===== FIREBASE INIT ===== -->
<script src="firebase.js"></script>
  <script>
/* ================= GLOBAL ================= */
let map, marker;
let currentLat = null;
let currentLng = null;

/* ================= AUTH CHECK ================= */
auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href="index.html";
  }else{
    listenEmergency();
  }
});
  /* ================= AUTH CHECK ================= */
auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href="index.html";
  }else{
    listenEmergency();
  }
});

/* ================= LISTEN EMERGENCY ================= */
function listenEmergency(){
  db.collection("emergencies")
    .where("status","==","ACTIVE")
    .orderBy("time","desc")
    .limit(1)
    .onSnapshot(snapshot=>{
      snapshot.forEach(doc=>{
        const d=doc.data();
        showEmergency(d.lat,d.lng,d.time);
      });
    });
}
/* ================= SHOW EMERGENCY ================= */
/* ================= CALL PATIENT ================= */
function callPatient(){
  if(!currentPatientPhone){
    alert("âŒ Patient contact not available");
    return;
  }
  actionStatus.innerText="ğŸ“± Calling patient...";
  window.location.href = "tel:" + currentPatientPhone;
}
function showEmergency(lat,lng,time){
  currentLat = lat;
  currentLng = lng;

  // âœ… GET PATIENT DATA
  db.collection("patient_details")
    .doc(currentPatientUID)
    .get()
    .then(doc=>{
      if(doc.exists){
        currentPatientPhone = doc.data().emergencyNumber;
      }
    });

  actionStatus.innerText="ğŸŸ¢ Patient connected â€¢ Ready";
}
  currentLat=lat;
  currentLng=lng;

  document.getElementById("actionStatus").innerText =
    "ğŸŸ¢ Patient monitor connected â€¢ Location ready";

  const t=time?.seconds
    ? new Date(time.seconds*1000)
    : new Date(time);

  alertInfo.innerText =
    "Emergency detected â€¢ "+t.toLocaleTimeString();

  const loc={lat,lng};

  if(!map){
    map=new google.maps.Map(monitorMap,{
      zoom:16,
      center:loc
    });
    marker=new google.maps.Marker({
      map,
      position:loc,
      title:"Patient Location"
    });
  }else{
    map.setCenter(loc);
    marker.setPosition(loc);
  }

  mapFrame.src =
    `https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed`;
}
  /* ================= ACTIONS ================= */
function callHospital(){
  if(!currentLat||!currentLng){
    alert("âŒ Patient location not ready");
    return;
  }
  actionStatus.innerText="ğŸ“ Calling nearest hospital...";
  window.open(
    `https://www.google.com/maps/search/emergency+hospital/@${currentLat},${currentLng},15z`,
    "_blank"
  );
}

function navigate(){
  if(!currentLat||!currentLng){
    alert("âŒ Location not ready");
    return;
  }
  actionStatus.innerText="ğŸ§­ Opening live navigation...";
  window.open(
    `https://www.google.com/maps/dir/?api=1&destination=${currentLat},${currentLng}`,
    "_blank"
  );
}

function callEmergency(){
  actionStatus.innerText="ğŸš‘ Connecting to emergency services...";
  window.location.href="tel:911";
}
</script>

</body>
</html>
<script>
/* ================= GLOBAL ================= */
let map, marker;
let currentLat = null;
let currentLng = null;
let currentPatientUID = null;
let currentPatientPhone = null;

/* ================= AUTH ================= */
auth.onAuthStateChanged(user=>{
  if(!user){
    location.href="index.html";
  }else{
    listenEmergency();
  }
});

/* ================= LISTEN EMERGENCY ================= */
function listenEmergency(){
  db.collection("emergencies")
    .where("status","==","ACTIVE")
    .orderBy("time","desc")
    .limit(1)
    .onSnapshot(snapshot=>{
      snapshot.forEach(doc=>{
        const d = doc.data();
        currentPatientUID = d.uid;
        showEmergency(d.lat,d.lng,d.time);
      });
    });
}

/* ================= SHOW EMERGENCY ================= */
function showEmergency(lat,lng,time){
  currentLat = lat;
  currentLng = lng;

  const t = time?.seconds
    ? new Date(time.seconds*1000)
    : new Date(time);

  alertInfo.innerText =
    "Emergency detected â€¢ " + t.toLocaleTimeString();

  actionStatus.innerText =
    "ğŸŸ¢ Patient monitor connected â€¢ Location ready";

  /* MAP */
  const loc = {lat,lng};

  if(!map){
    map = new google.maps.Map(
      document.getElementById("monitorMap"),
      {zoom:16, center:loc}
    );

    marker = new google.maps.Marker({
      map,
      position:loc,
      title:"Patient Location"
    });
  }else{
    map.setCenter(loc);
    marker.setPosition(loc);
  }

  mapFrame.src =
    `https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed`;

  /* GET PATIENT PHONE */
  db.collection("patient_details")
    .doc(currentPatientUID)
    .get()
    .then(doc=>{
      if(doc.exists){
        currentPatientPhone = doc.data().emergencyNumber;
      }
    });
}

/* ================= ACTION BUTTONS ================= */
function callHospital(){
  if(!currentLat){
    alert("âŒ Patient location not ready");
    return;
  }
  actionStatus.innerText="ğŸ“ Opening nearest hospitals...";
  window.open(
    `https://www.google.com/maps/search/emergency+hospital/@${currentLat},${currentLng},15z`,
    "_blank"
  );
}

function navigate(){
  if(!currentLat){
    alert("âŒ Location not ready");
    return;
  }
  actionStatus.innerText="ğŸ§­ Live navigation...";
  window.open(
    `https://www.google.com/maps/dir/?api=1&destination=${currentLat},${currentLng}`,
    "_blank"
  );
}

function callEmergency(){
  actionStatus.innerText="ğŸš‘ Calling emergency services...";
  window.location.href="tel:911";
}

function callPatient(){
  if(!currentPatientPhone){
    alert("âŒ Patient contact not available");
    return;
  }
  actionStatus.innerText="ğŸ“± Calling patient...";
  window.location.href="tel:"+currentPatientPhone;
}
</script>

  

    
    
}
</script>

</body>
</html>